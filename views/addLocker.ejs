<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Locker</title>

  <!-- Bootstrap & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

  <style>
    body {
      background: linear-gradient(135deg, #0f766e, #14b8a6);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .card {
      border-radius: 18px;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.25);
      background: #ffffff;
      width: 90%;
      max-width: 750px;

      padding: 2rem;
    }

    .card-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .logo {
      height: 70px;
      margin-bottom: 10px;
    }

    h3 {
      font-weight: bold;
      color: #0f766e;
    }

    .form-label {
      font-weight: 600;
      color: #1f2937;
    }

    .input-group-text {
      background: #ecfdf5;
      border-right: none;
      color: #0f766e;
    }

    .form-control,
    .form-select {
      border-left: none;
      box-shadow: none !important;
    }

    .compartment-row {
      background: #f9fafb;
      border: 1px solid #d1fae5;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: #0f766e;
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: #115e59;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(17, 94, 89, 0.4);
    }

    .btn-outline-primary {
      border-radius: 8px;
      border-color: #0f766e;
      color: #0f766e;
    }

    .btn-outline-primary:hover {
      background: #0f766e;
      color: #fff;
    }

    .btn-danger {
      border-radius: 8px;
    }

    .list-group-item {
      cursor: pointer;
    }

    #suggestions {
      z-index: 1050;
      position: absolute;
      width: 100%;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #000000;
      margin-top: 20px;
      margin-bottom: 10px;
      border-bottom: 2px solid #d1fae5;
      padding-bottom: 6px;
    }

    .logo-container {
      display: inline-block;
      background: linear-gradient(135deg, #000000, #000000);
      /* teal background */
      padding: 12px 18px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .logo {
      height: 50px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
      /* add visibility */
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="card-header text-center">
      <div class="logo-container mb-3">
        <img src="/uploads/droppointlogo.png" alt="Logo" class="logo" style="height: 80px;" />
      </div>
      <h3>Add New Locker</h3>
    </div>

    <% if (messages.success && messages.success.length> 0) { %>
      <div class="alert alert-success">
        <%= messages.success[0] %>
      </div>
      <% } %>

        <% if (messages.error && messages.error.length> 0) { %>
          <div class="alert alert-danger">
            <%= messages.error[0] %>
          </div>
          <% } %>

            <form action="/add-locker" method="POST">
              <!-- Locker Info -->
              <div class="section-title">Locker Info</div>
              <div class="mb-3">
                <label for="lockerId" class="form-label">Locker ID</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                  <input type="text" class="form-control" id="lockerId" name="lockerId"
                    placeholder="Enter unique Locker ID" required />
                </div>
              </div>

              <!-- Location -->
              <div class="section-title">Location</div>
              <div class="mb-3">
                <label for="locationSearch" class="form-label">Search Locker Location</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-map-pin"></i></span>
                  <input type="text" id="locationSearch" class="form-control" placeholder="Enter a location" required />
                </div>
                <ul id="suggestions" class="list-group mt-1"></ul>
              </div>

              <button type="button" id="getLocationBtn" class="btn btn-outline-primary mb-3 w-100">
                <i class="fas fa-location-arrow me-2"></i>Use My Location
              </button>

              <input type="hidden" name="address" id="addressField" />
              <input type="hidden" name="lat" id="latField" />
              <input type="hidden" name="lng" id="lngField" />

              <!-- Compartments -->
              <div class="section-title">Compartments</div>
              <div id="compartmentsContainer"></div>
              <button type="button" class="btn btn-secondary mt-2" onclick="addCompartment()">
                <i class="fas fa-plus me-1"></i>Add Compartment
              </button>

              <!-- Save Button -->
              <!-- Save Button -->
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="fas fa-save me-2"></i>Save Locker
                </button>
              </div>

              <!-- Show All Lockers -->
              <div class="d-grid mt-3">
                <a href="/lockers" class="btn btn-outline-primary btn-lg">
                  <i class="fas fa-boxes me-2"></i>Show All Lockers
                </a>
              </div>

            </form>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const searchInput = document.getElementById('locationSearch');
    const suggestions = document.getElementById('suggestions');

    searchInput.addEventListener('input', async () => {
      const query = searchInput.value;
      if (!query) {
        suggestions.innerHTML = '';
        return;
      }

      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
      const data = await res.json();
      suggestions.innerHTML = '';

      data.slice(0, 5).forEach(place => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.textContent = place.display_name;
        li.addEventListener('click', () => {
          searchInput.value = place.display_name;
          document.getElementById('addressField').value = place.display_name;
          document.getElementById('latField').value = place.lat;
          document.getElementById('lngField').value = place.lon;
          suggestions.innerHTML = '';
        });
        suggestions.appendChild(li);
      });
    });
    const getLocationBtn = document.getElementById('getLocationBtn');

    getLocationBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      getLocationBtn.innerHTML = '‚è≥ Getting location...';
      getLocationBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        document.getElementById('latField').value = lat;
        document.getElementById('lngField').value = lon;

        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
          const data = await res.json();
          const address = data.display_name || 'Address not found';

          document.getElementById('addressField').value = address;
          document.getElementById('locationSearch').value = address;
        } catch (err) {
          alert("Failed to fetch address.");
          console.error(err);
        }

        getLocationBtn.innerHTML = 'üìç Use My Location';
        getLocationBtn.disabled = false;

      }, (err) => {
        alert("Unable to get your location. Permission denied or device error.");
        getLocationBtn.innerHTML = 'üìç Use My Location';
        getLocationBtn.disabled = false;
      });
    });
  </script>

  <script>
    let compartmentCount = 0;

    function addCompartment() {
      const container = document.getElementById('compartmentsContainer');
      const div = document.createElement('div');
      div.className = "row g-3 compartment-row align-items-end";
      div.innerHTML = `
      <div class="col-md-3">
        <label class="form-label">Compartment ID</label>
        <input type="text" class="form-control" value="${compartmentCount + 1}" readonly />
        <input type="hidden" name="compartments[${compartmentCount}][compartmentId]" value="${compartmentCount}" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Size</label>
        <select class="form-select" name="compartments[${compartmentCount}][size]" required>
          <option value="">Select size</option>
          <option value="small">Small</option>
          <option value="medium" selected>Medium</option>
          <option value="large">Large</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Utility</label>
        <select class="form-select" name="compartments[${compartmentCount}][utility]" required>
          <option value="standard" selected>Standard</option>
          <option value="cooler">Cooler</option>
          <option value="freezer">Freezer</option>
          <option value="temperature-controlled">Temperature Controlled</option>
          <option value="electronics-safe">Electronics Safe</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <button type="button" class="btn btn-danger" onclick="removeCompartment(this)">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
      container.appendChild(div);
      compartmentCount++;
    }

    function removeCompartment(btn) {
      btn.closest('.compartment-row').remove();
      const rows = document.querySelectorAll('.compartment-row');
      compartmentCount = 0;
      rows.forEach((row, i) => {
        const visibleInput = row.querySelector('input[readonly]');
        const hiddenInput = row.querySelector('input[type="hidden"]');
        const sizeSelect = row.querySelector('select[name*="[size]"]');
        const utilitySelect = row.querySelector('select[name*="[utility]"]');

        visibleInput.value = i + 1;
        hiddenInput.name = `compartments[${i}][compartmentId]`;
        hiddenInput.value = i;
        sizeSelect.name = `compartments[${i}][size]`;
        utilitySelect.name = `compartments[${i}][utility]`;

        compartmentCount++;
      });
    }
  </script>

</body>

</html>
