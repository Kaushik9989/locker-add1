<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Lockers</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
  <style>
    :root{--teal-1:#06b6d4;--teal-2:#14b8a6;}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#f3f7f7;padding:16px}
    .card-surface{border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.06);background:#fff}
    .table-wrap{max-height:65vh;overflow:auto}
    .locker-card{border:1px solid #e6f7f5;border-radius:10px;padding:12px;margin-bottom:12px;background:#fff;box-shadow:0 4px 10px rgba(5,10,12,0.03)}
    .locker-meta{font-size:0.85rem;color:#6b7280}
    .comp-list{padding-left:0;margin:0;list-style:none}
    .comp-list li{font-size:0.9rem;color:#374151;margin-bottom:4px}
    @media (max-width:767.98px){.table-responsive{display:none}.desktop-actions{display:none}.mobile-actions{display:block}}
    @media (min-width:768px){.mobile-list{display:none}}
    .muted{color:#6b7280;font-size:0.9rem}
    .btn-icon{padding:0.45rem 0.6rem;font-size:0.9rem;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">All Lockers</h3>
      <div>
        <a href="/" class="btn btn-outline-secondary me-2"><i class="fas fa-arrow-left me-1"></i>Back</a>
        <a href="/" class="btn btn-primary"><i class="fas fa-plus me-1"></i>Add Locker</a>
      </div>
    </div>

    <% if (messages && messages.success && messages.success.length) { %>
      <div class="alert alert-success"><%= messages.success[0] %></div>
    <% } %>
    <% if (messages && messages.error && messages.error.length) { %>
      <div class="alert alert-danger"><%= messages.error[0] %></div>
    <% } %>

    <div class="card-surface p-3 mb-3">
      <div class="row g-2 align-items-center mb-2">
        <div class="col-8 col-md-6">
          <input id="filterInput" class="form-control" placeholder="Filter by locker id, address or compartment..." />
        </div>
        <div class="col-4 col-md-6 text-end">
          <small class="text-muted">Showing <strong id="countDisplay"><%= lockers.length %></strong> lockers (newest first)</small>
        </div>
      </div>

      <% /* helper to build a safe search-text server-side, avoid backticks and ${} */ %>
      <% function makeSearchText(locker) {
           var addr = (locker.location && locker.location.address) ? locker.location.address : '';
           var latlng = (locker.location && locker.location.lat) ? (String(locker.location.lat) + ', ' + String(locker.location.lng)) : '';
           var comps = '';
           if (Array.isArray(locker.compartments) && locker.compartments.length) {
             var tmp = [];
             for (var i=0; i<locker.compartments.length; i++) {
               var c = locker.compartments[i];
               tmp.push((c.compartmentId || '') + ' ' + (c.size || '') + ' ' + (c.utility || ''));
             }
             comps = tmp.join(' ');
           }
           return (String(locker.lockerId || '') + ' ' + addr + ' ' + latlng + ' ' + comps).toLowerCase();
         } %>

      <!-- Desktop table -->
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Locker ID</th>
              <th>Address</th>
              <th>Lat,Lng</th>
              <th>Compartments</th>
              <th>Added</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody id="lockersTbody">
            <% lockers.forEach(function(locker) {
                 var added = locker.createdAt ? new Date(locker.createdAt).toLocaleString()
                   : new Date(parseInt(locker._id.toString().substring(0,8),16) * 1000).toLocaleString();
                 var address = (locker.location && locker.location.address) ? locker.location.address : '-';
                 var latlng = (locker.location && locker.location.lat) ? (locker.location.lat + ', ' + locker.location.lng) : '-';
                 var searchText = makeSearchText(locker);
            %>
              <tr data-search="<%= searchText.replace(/\"/g, '&quot;') %>">
                <td class="fw-bold"><%= locker.lockerId %></td>
                <td style="min-width:250px;"><%= address %></td>
                <td><%= latlng %></td>
                <td>
                  <% if (Array.isArray(locker.compartments) && locker.compartments.length) { %>
                    <ul class="mb-0">
                      <% locker.compartments.forEach(function(c) { %>
                        <li style="list-style:none"><span class="badge bg-light text-dark me-1">#<%= c.compartmentId %></span> <small class="text-muted"><%= c.size || 'medium' %> <%= c.utility ? (' | ' + c.utility) : '' %></small></li>
                      <% }) %>
                    </ul>
                  <% } else { %>
                    <small class="text-muted">No compartments</small>
                  <% } %>
                </td>
                <td><%= added %></td>
                <td class="text-end desktop-actions">
                  <button class="btn btn-sm btn-outline-danger btn-icon" onclick="deleteLocker('<%= locker.lockerId %>')">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Mobile card list -->
      <div class="mobile-list mt-2" id="mobileList">
        <% lockers.forEach(function(locker) {
             var added = locker.createdAt ? new Date(locker.createdAt).toLocaleString()
               : new Date(parseInt(locker._id.toString().substring(0,8),16) * 1000).toLocaleString();
             var address = (locker.location && locker.location.address) ? locker.location.address : '-';
             var latlng = (locker.location && locker.location.lat) ? (locker.location.lat + ', ' + locker.location.lng) : '-';
             var searchText = makeSearchText(locker);
        %>
          <div class="locker-card" data-search="<%= searchText.replace(/\"/g, '&quot;') %>">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <div>
                <div class="fw-bold"><%= locker.lockerId %></div>
                <div class="muted locker-meta"><%= address %></div>
              </div>
              <div class="text-end">
                <div class="muted" style="font-size:0.85rem"><%= added %></div>
                <div class="mt-2 mobile-actions">
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteLocker('<%= locker.lockerId %>')">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </div>
            </div>
            <div class="mb-1">
              <small class="muted">Coords:</small>
              <div class="locker-meta"><%= latlng %></div>
            </div>
            <div>
              <small class="muted">Compartments:</small>
              <% if (Array.isArray(locker.compartments) && locker.compartments.length) { %>
                <ul class="comp-list mt-1 mb-0">
                  <% locker.compartments.forEach(function(c) { %>
                    <li>#<%= c.compartmentId %> â€” <%= c.size || 'medium' %> <span class="muted"><%= c.utility ? ('| ' + c.utility) : '' %></span></li>
                  <% }) %>
                </ul>
              <% } else { %>
                <div class="locker-meta">No compartments</div>
              <% } %>
            </div>
          </div>
        <% }) %>
      </div>

    </div>
  </div>

  <script>
    const filterInput = document.getElementById('filterInput');
    const tableRows = Array.from(document.querySelectorAll('#lockersTbody tr'));
    const mobileCards = Array.from(document.querySelectorAll('#mobileList [data-search]'));
    const countDisplay = document.getElementById('countDisplay');

    function updateCount(visible) { countDisplay.textContent = visible; }

    function filterAll(q) {
      q = q.trim().toLowerCase();
      let visible = 0;
      tableRows.forEach(r => {
        const text = r.getAttribute('data-search') || r.innerText.toLowerCase();
        const ok = q === '' || text.indexOf(q) !== -1;
        r.style.display = ok ? '' : 'none';
        if (ok) visible++;
      });
      mobileCards.forEach(c => {
        const text = c.getAttribute('data-search') || c.innerText.toLowerCase();
        const ok = q === '' || text.indexOf(q) !== -1;
        c.style.display = ok ? '' : 'none';
      });
      updateCount(visible);
    }

    filterInput.addEventListener('input', (e) => filterAll(e.target.value));

    async function deleteLocker(lockerId) {
      if (!confirm('Delete locker ' + lockerId + '?')) return;
      try {
        const res = await fetch('/api/locker/' + encodeURIComponent(lockerId), { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          // remove matching elements from DOM
          document.querySelectorAll('[data-search]').forEach(el => {
            if ((el.getAttribute('data-search') || '').indexOf(lockerId.toLowerCase()) !== -1) el.remove();
          });
          updateCount(document.querySelectorAll('#lockersTbody tr').length);
          alert(data.message);
        } else {
          alert('Error: ' + data.message);
        }
      } catch (err) {
        console.error(err);
        alert('Request failed.');
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
